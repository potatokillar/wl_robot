pipeline {
    agent any

    options {
        buildDiscarder(logRotator(
            numToKeepStr: '10',        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
            artifactNumToKeepStr: '5'  // ä¿ç•™æœ€è¿‘5æ¬¡æ„å»ºçš„äº§ç‰©
        ))
    }

    parameters {
        choice(
            name: 'ARCHITECTURE',
            choices: ['x86', 'arm'],
            description: '''ç›®æ ‡æ¶æ„ï¼š
            - x86: x86_64 æ¶æ„ç¼–è¯‘
            - arm: ARM64 æ¶æ„äº¤å‰ç¼–è¯‘ï¼ˆä½¿ç”¨ Docker é•œåƒä¸­çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼‰'''
        )
    }

    triggers {
        // æ¯24å°æ—¶è‡ªåŠ¨æ„å»ºä¸€æ¬¡ï¼ˆä¸ç®¡æ˜¯å¦æœ‰ä»£ç å˜æ›´ï¼‰
        cron('H 0 * * *')
    }

    environment {
        GIT_REPO = 'http://192.168.1.55/ontology/qr_wl.git'
        GIT_BRANCH = 'main'
        GIT_CREDENTIALS = 'http://root:westlake@192.168.1.55'
        DOCKER_IMAGE = '192.168.1.93/iiri/build_x86_arm_ros1:latest'
        CI = 'true'  // æ ‡è®°ä¸º CI ç¯å¢ƒ,ç¦ç”¨ docker -it å‚æ•°
        ORIN_HOST = '192.168.1.61'
        ORIN_USER = 'wl'
        ORIN_PASS = '123456'
    }

    stages {
        stage('æ¸…ç†å·¥ä½œç©ºé—´') {
            steps {
                echo '=== æ¸…ç†æ—§çš„å·¥ä½œç©ºé—´ ==='
                deleteDir()
            }
        }

        stage('æ‹‰å–ä»£ç ') {
            steps {
                echo '=== æ‹‰å–ä¸»ä»“åº“ä»£ç  ==='
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'git-cred'
                    ]]
                ])

                echo '=== é…ç½® Git å‡­æ® ==='
                sh '''
                    git config --global credential.helper store
                    echo "${GIT_CREDENTIALS}" > ~/.git-credentials
                    git config --global user.name "Jenkins CI"
                    git config --global user.email "jenkins@iiri.local"
                '''
            }
        }

        stage('æ£€æŸ¥ Docker') {
            steps {
                echo '=== æ£€æŸ¥ Docker å¯ç”¨æ€§ ==='
                sh '''
                    set +e

                    echo "è¯Šæ–­ä¿¡æ¯:"
                    echo "  PATH: $PATH"
                    echo "  æ£€æŸ¥ docker å‘½ä»¤:"
                    command -v docker
                    DOCKER_CHECK=$?

                    set -e

                    # åˆ¤æ–­ docker æ˜¯å¦å¯ç”¨
                    if [ $DOCKER_CHECK -ne 0 ]; then
                        echo ""
                        echo "ERROR: Docker æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
                        echo ""
                        echo "è¯·ç¡®ä¿:"
                        echo "  1. Docker å·²å®‰è£…"
                        echo "  2. Docker åœ¨ PATH ä¸­"
                        echo "  3. Docker socket å·²æŒ‚è½½"
                        exit 1
                    fi

                    echo ""
                    echo "=== Docker ç‰ˆæœ¬ ==="
                    docker --version

                    echo ""
                    echo "=== æµ‹è¯• Docker è¿è¡Œ ==="
                    if docker ps >/dev/null 2>&1; then
                        echo "âœ“ Docker è®¿é—®æ­£å¸¸"
                        docker ps --format "table {{.Names}}\t{{.Status}}" | head -5
                    else
                        echo "ERROR: æ— æ³•è®¿é—® Docker socket"
                        echo "è¯·æ£€æŸ¥:"
                        echo "  1. Docker socket æ˜¯å¦æŒ‚è½½: /var/run/docker.sock"
                        echo "  2. Socket æƒé™: chmod 666 /var/run/docker.sock"
                        exit 1
                    fi
                '''
            }
        }

        stage('æ‹‰å– Docker é•œåƒ') {
            steps {
                echo "=== æ‹‰å–æœ€æ–° Docker é•œåƒ ==="
                echo "ç›®æ ‡é•œåƒ: ${DOCKER_IMAGE}"

                sh """
                    echo "æ­£åœ¨æ‹‰å–é•œåƒ..."
                    docker pull ${DOCKER_IMAGE}

                    echo ""
                    echo "=== é•œåƒä¿¡æ¯ ==="
                    docker images ${DOCKER_IMAGE} --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}"

                    echo ""
                    echo "âœ“ é•œåƒæ‹‰å–å®Œæˆ"
                """
            }
        }

        stage('ç¼–è¯‘') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    // æ‰€æœ‰æ¶æ„éƒ½åœ¨ Jenkins ä¸Šç”¨ Docker äº¤å‰ç¼–è¯‘
                    if (params.ARCHITECTURE == 'arm') {
                        echo "ğŸ”¨ ARM äº¤å‰ç¼–è¯‘æ¨¡å¼ï¼ˆJenkins ä¸Šä½¿ç”¨ Docker é•œåƒäº¤å‰ç¼–è¯‘ï¼‰"
                    } else {
                        echo "ğŸ’» x86 æœ¬åœ°ç¼–è¯‘"
                    }

                        // ç›´æ¥åœ¨ Jenkins ä¸­è¿è¡Œ Docker ç¼–è¯‘ï¼Œé¿å…åµŒå¥— Docker è·¯å¾„é—®é¢˜
                        sh """
                            # æ£€æµ‹å®¿ä¸»æœºè·¯å¾„æ˜ å°„
                            # Jenkins è¿è¡Œåœ¨ Docker ä¸­ï¼Œ/var/jenkins_home æŒ‚è½½åˆ°å®¿ä¸»æœº /home/wl/jenkins_data
                            WORKSPACE_PATH="\$(pwd)"

                            # ä» /proc/1/mountinfo è·å–å®¿ä¸»æœºæŒ‚è½½ç‚¹
                            if [ -f /proc/1/mountinfo ]; then
                                JENKINS_HOME_HOST=\$(grep "/var/jenkins_home" /proc/1/mountinfo | head -1 | awk '{print \$4}')
                                # å°† Jenkins å®¹å™¨å†…è·¯å¾„è½¬æ¢ä¸ºå®¿ä¸»æœºè·¯å¾„
                                # /var/jenkins_home/workspace/... -> /home/wl/jenkins_data/workspace/...
                                HOST_WORKSPACE=\$(echo "\${WORKSPACE_PATH}" | sed "s|/var/jenkins_home|\${JENKINS_HOME_HOST}|")
                            else
                                HOST_WORKSPACE="\${WORKSPACE_PATH}"
                            fi

                            echo "=== è·¯å¾„ä¿¡æ¯ ==="
                            echo "Jenkins å·¥ä½œç›®å½•: \${WORKSPACE_PATH}"
                            echo "Jenkins Home å®¿ä¸»æœºè·¯å¾„: \${JENKINS_HOME_HOST}"
                            echo "å·¥ä½œç©ºé—´å®¿ä¸»æœºè·¯å¾„: \${HOST_WORKSPACE}"

                            # æ£€æµ‹ GPU æ”¯æŒ
                            GPU_FLAG=""
                            if nvidia-smi > /dev/null 2>&1; then
                                GPU_FLAG="--gpus=all"
                                echo "âœ“ æ£€æµ‹åˆ° NVIDIA GPUï¼Œå¯ç”¨ GPU æ”¯æŒ"
                            else
                                echo "â„¹ æœªæ£€æµ‹åˆ° NVIDIA GPUï¼Œè·³è¿‡ GPU æ”¯æŒ"
                            fi

                            # è·å–å½“å‰ç”¨æˆ·çš„ UID/GIDï¼ˆJenkins å®¹å™¨å†…çš„å®é™…ç”¨æˆ·ï¼‰
                            CURRENT_UID=\$(id -u)
                            CURRENT_GID=\$(id -g)
                            CURRENT_USER=\$(whoami)

                            echo "å½“å‰ç”¨æˆ·: \${CURRENT_USER} (UID:\${CURRENT_UID}, GID:\${CURRENT_GID})"

                            # ä½¿ç”¨å®¿ä¸»æœºè·¯å¾„è¿è¡Œ Docker ç¼–è¯‘
                            docker run \
                                -v "\${HOST_WORKSPACE}:/workspace" \
                                -w "/workspace" \
                                -v /dev:/dev \
                                -e USER_NAME=\${CURRENT_USER} \
                                -e USER_UID=\${CURRENT_UID} \
                                -e USER_GID=\${CURRENT_GID} \
                                -e USER_HOME=/home/\${CURRENT_USER} \
                                -i --rm --network=host --privileged \${GPU_FLAG} \
                                ${env.DOCKER_IMAGE} \
                                bash -c 'source ~/.bashrc && ./script/build.sh ${params.ARCHITECTURE}'
                        """
                }
            }
        }

        stage('æ‰“åŒ…éƒ¨ç½²åŒ…') {
            steps {
                echo "=== æ‰“åŒ… qr_wl éƒ¨ç½²åŒ… (${params.ARCHITECTURE}) ==="
                sh """
                    # ç¡®ä¿æ‰“åŒ…è„šæœ¬å¯æ‰§è¡Œ
                    chmod +x deploy_package_qr.sh

                    # æ‰§è¡Œæ‰“åŒ…ï¼ˆè·³è¿‡æ„å»ºï¼Œä½¿ç”¨å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶ï¼‰
                    ./deploy_package_qr.sh ${params.ARCHITECTURE} deploy_packages --skip-build

                    # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
                    echo ""
                    echo "=== æ‰“åŒ…å®Œæˆ ==="
                    ls -lh deploy_packages/*.tar.gz
                    ls -lh deploy_packages/*.sha256 2>/dev/null || echo "(æœªç”Ÿæˆæ ¡éªŒæ–‡ä»¶)"

                    # æ˜¾ç¤ºéƒ¨ç½²åŒ…å†…å®¹
                    echo ""
                    echo "=== éƒ¨ç½²åŒ…å†…å®¹é¢„è§ˆ ==="
                    tar -tzf deploy_packages/*.tar.gz | head -20
                """
            }
        }
    }

    post {
        always {
            echo '=== æ„å»ºç»“æŸ ==='
        }

        success {
            echo '=== ç¼–è¯‘æˆåŠŸ! ==='

            // å½’æ¡£éƒ¨ç½²åŒ…åˆ°Jenkinsä¾›ä¸‹è½½ï¼ˆä¸»è¦äº§ç‰©ï¼‰
            echo '=== å½’æ¡£éƒ¨ç½²åŒ… ==='
            archiveArtifacts artifacts: "deploy_packages/*.tar.gz",
                             fingerprint: true,
                             allowEmptyArchive: false

            // å½’æ¡£ SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            archiveArtifacts artifacts: "deploy_packages/*.sha256",
                             fingerprint: false,
                             allowEmptyArchive: true

            // å½’æ¡£ç‰ˆæœ¬ä¿¡æ¯
            archiveArtifacts artifacts: "deploy_packages/*/VERSION.txt",
                             fingerprint: false,
                             allowEmptyArchive: true

            // å½’æ¡£ç¼–è¯‘æ—¥å¿—ï¼ˆæ¬¡è¦äº§ç‰©ï¼‰
            echo '=== å½’æ¡£ç¼–è¯‘æ—¥å¿— ==='
            archiveArtifacts artifacts: "build/**/log/**/*.log",
                             fingerprint: false,
                             allowEmptyArchive: true

            echo ''
            echo '=========================================='
            echo 'ğŸ‰ éƒ¨ç½²åŒ…å·²å½’æ¡£ï¼'
            echo '=========================================='
            echo ''
            echo 'ğŸ“¦ ä» Jenkins UI ä¸‹è½½éƒ¨ç½²åŒ…åï¼Œéƒ¨ç½²åˆ°æ ‘è“æ´¾ï¼š'
            echo ''
            echo '1ï¸âƒ£  ä¸‹è½½éƒ¨ç½²åŒ…åˆ°æœ¬åœ°'
            echo '   wget http://admin:westlake@192.168.1.93:8080/job/qr-wl-build-ci/lastSuccessfulBuild/artifact/deploy_packages/*.tar.gz'
            echo ''
            echo '2ï¸âƒ£  ä¸Šä¼ åˆ°æ ‘è“æ´¾'
            echo '   scp iiri-qr-*.tar.gz wl@192.168.1.54:/home/wl/autorun/'
            echo ''
            echo '3ï¸âƒ£  è§£å‹å¹¶éƒ¨ç½²'
            echo '   ssh wl@192.168.1.54 "cd /home/wl/autorun && tar -xzf iiri-qr-*.tar.gz && cd iiri-qr-* && ./install.sh"'
            echo ''
            echo '=========================================='
        }

        failure {
            echo '=== ç¼–è¯‘å¤±è´¥! ==='

            // å¤±è´¥æ—¶å½’æ¡£æ—¥å¿—ç”¨äºè°ƒè¯•
            echo '=== å½’æ¡£å¤±è´¥æ—¥å¿— ==='
            archiveArtifacts artifacts: "build/**/log/**/*.log",
                             fingerprint: false,
                             allowEmptyArchive: true
        }
    }
}
