pipeline {
    agent any

    options {
        buildDiscarder(logRotator(
            numToKeepStr: '10',        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
            artifactNumToKeepStr: '5'  // ä¿ç•™æœ€è¿‘5æ¬¡æ„å»ºçš„äº§ç‰©
        ))
    }

    parameters {
        choice(
            name: 'ARCHITECTURE',
            choices: ['x86', 'arm'],
            description: 'ç›®æ ‡æ¶æ„'
        )
        choice(
            name: 'BUILD_MODE',
            choices: ['debug', 'release'],
            description: '''ARM æ„å»ºæ¨¡å¼ï¼ˆä»… ARM æ¶æ„ç”Ÿæ•ˆï¼‰
            - debug: Jenkins QEMU ç¼–è¯‘ï¼ˆDebug æ¨¡å¼ï¼Œæœ‰é™åˆ¶ï¼Œå¿«é€Ÿæµ‹è¯•ï¼‰
            - release: Orin ç¡¬ä»¶ç¼–è¯‘ï¼ˆRelease æ¨¡å¼ï¼Œæ— é™åˆ¶ï¼Œç”Ÿäº§å‘å¸ƒï¼‰'''
        )
        booleanParam(
            name: 'ENABLE_CERES',
            defaultValue: false,
            description: 'æ˜¯å¦å¯ç”¨ Ceres ä¼˜åŒ–ï¼ˆä»…å½±å“ intelligence_layerï¼‰'
        )
    }

    triggers {
        // æ¯12å°æ—¶è‡ªåŠ¨æ„å»ºä¸€æ¬¡ï¼ˆä¸ç®¡æ˜¯å¦æœ‰ä»£ç å˜æ›´ï¼‰
        cron('H */12 * * *')
    }

    environment {
        GIT_REPO = 'http://192.168.1.55/ontology/iiri_ros2_architecture.git'
        GIT_BRANCH = 'master'
        GIT_CREDENTIALS = 'http://root:westlake@192.168.1.55'
        DOCKER_IMAGE_X86 = '192.168.1.93/iiri/build_x86_ros2:latest'
        DOCKER_IMAGE_ARM = '192.168.1.93/iiri/build_arm_ros2:latest'
        CI = 'true'  // æ ‡è®°ä¸º CI ç¯å¢ƒ,ç¦ç”¨ docker -it å‚æ•°
    }

    stages {
        stage('æ¸…ç†å·¥ä½œç©ºé—´') {
            steps {
                echo '=== æ¸…ç†æ—§çš„å·¥ä½œç©ºé—´ ==='
                deleteDir()
            }
        }

        stage('æ‹‰å–ä¸»ä»“åº“') {
            steps {
                echo '=== æ‹‰å–ä¸»ä»“åº“ä»£ç  ==='
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'git-cred'
                    ]]
                ])
            }
        }

        stage('é…ç½® Git å‡­æ®å¹¶å¯¼å…¥åˆ†å±‚ä»£ç ') {
            steps {
                echo '=== é…ç½® Git å‡­æ® ==='
                sh '''
                    git config --global credential.helper store
                    echo "${GIT_CREDENTIALS}" > ~/.git-credentials
                    git config --global user.name "Jenkins CI"
                    git config --global user.email "jenkins@iiri.local"
                '''

                echo '=== æ£€æŸ¥ vcstool ==='
                sh '''
                    set +e  # æš‚æ—¶ç¦ç”¨é”™è¯¯ç«‹å³é€€å‡º

                    echo "è¯Šæ–­ä¿¡æ¯:"
                    echo "  PATH: $PATH"
                    echo "  æ£€æŸ¥ vcs å‘½ä»¤:"
                    command -v vcs
                    VCS_CHECK=$?

                    echo "  æ£€æŸ¥ which vcs:"
                    which vcs
                    WHICH_CHECK=$?

                    set -e  # é‡æ–°å¯ç”¨é”™è¯¯ç«‹å³é€€å‡º

                    # åˆ¤æ–­ vcstool æ˜¯å¦å®‰è£…
                    if [ $VCS_CHECK -ne 0 ] || [ $WHICH_CHECK -ne 0 ]; then
                        echo ""
                        echo "ERROR: vcstool æœªå®‰è£…åœ¨ Jenkins æœåŠ¡å™¨ä¸Š"
                        echo ""
                        echo "è¯·åœ¨ Jenkins å®¹å™¨æˆ–å®¿ä¸»æœºä¸­å®‰è£… vcstool:"
                        echo "  # ä½¿ç”¨ pip å®‰è£…"
                        echo "  pip3 install vcstool --break-system-packages"
                        echo ""
                        echo "  # æˆ–è€…åœ¨å®¹å™¨ä¸­å®‰è£…"
                        echo "  docker exec -it -u root <jenkins_container_id> bash"
                        echo "  apt-get update && apt-get install -y python3-pip"
                        echo "  pip3 install vcstool --break-system-packages"
                        echo "  exit"
                        echo ""
                        echo "è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹: jenkins/INSTALL_VCSTOOL.md"
                        exit 1
                    fi

                    echo ""
                    echo "=== vcstool ç‰ˆæœ¬ ==="
                    vcs --version
                '''

                echo '=== æ£€æŸ¥é¡¹ç›®ç»“æ„ ==='
                sh '''
                    echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
                    ls -la script/build_layered.sh || echo "ERROR: script/build_layered.sh ä¸å­˜åœ¨"
                    ls -la build_layered.sh || echo "ERROR: build_layered.sh ä¸å­˜åœ¨"
                '''

                echo '=== å¯¼å…¥åˆ†å±‚ä»£ç  ==='
                sh '''
                    # æ˜¾ç¤ºå½“å‰é…ç½®
                    echo "=== å½“å‰ .repos é…ç½® ==="
                    cat .repos

                    # ä½¿ç”¨ sync.sh å¯¼å…¥æ‰€æœ‰åˆ†å±‚ä»£ç 
                    chmod +x sync.sh
                    ./sync.sh import

                    # æ˜¾ç¤ºå¯¼å…¥çŠ¶æ€
                    echo "=== å·²å¯¼å…¥çš„ä»“åº“ ==="
                    ./sync.sh status
                '''
            }
        }

        stage('æ£€æŸ¥ Docker') {
            steps {
                echo '=== æ£€æŸ¥ Docker å¯ç”¨æ€§ ==='
                sh '''
                    set +e

                    echo "è¯Šæ–­ä¿¡æ¯:"
                    echo "  PATH: $PATH"
                    echo "  æ£€æŸ¥ docker å‘½ä»¤:"
                    command -v docker
                    DOCKER_CHECK=$?

                    set -e

                    # åˆ¤æ–­ docker æ˜¯å¦å¯ç”¨ï¼ˆåªä½¿ç”¨ command -vï¼‰
                    if [ $DOCKER_CHECK -ne 0 ]; then
                        echo ""
                        echo "ERROR: Docker æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
                        echo ""
                        echo "è¯·ç¡®ä¿:"
                        echo "  1. Docker å·²å®‰è£…"
                        echo "  2. Docker åœ¨ PATH ä¸­æˆ–ä½äº /usr/local/bin/docker"
                        echo "  3. Docker socket å·²æŒ‚è½½"
                        echo ""
                        echo "è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹: jenkins/DOCKER_ACCESS.md"
                        exit 1
                    fi

                    echo ""
                    echo "=== Docker ç‰ˆæœ¬ ==="
                    docker --version

                    echo ""
                    echo "=== æµ‹è¯• Docker è¿è¡Œ ==="
                    if docker ps >/dev/null 2>&1; then
                        echo "âœ“ Docker è®¿é—®æ­£å¸¸"
                        docker ps --format "table {{.Names}}\t{{.Status}}" | head -5
                    else
                        echo "ERROR: æ— æ³•è®¿é—® Docker socket"
                        echo "è¯·æ£€æŸ¥:"
                        echo "  1. Docker socket æ˜¯å¦æŒ‚è½½: /var/run/docker.sock"
                        echo "  2. Socket æƒé™: chmod 666 /var/run/docker.sock"
                        exit 1
                    fi
                '''
            }
        }

        stage('æ‹‰å– Docker é•œåƒ') {
            steps {
                script {
                    def dockerImage = params.ARCHITECTURE == 'x86' ? env.DOCKER_IMAGE_X86 : env.DOCKER_IMAGE_ARM

                    echo "=== æ‹‰å–æœ€æ–° Docker é•œåƒ ==="
                    echo "ç›®æ ‡é•œåƒ: ${dockerImage}"

                    sh """
                        echo "æ­£åœ¨æ‹‰å–é•œåƒ..."
                        docker pull ${dockerImage}

                        echo ""
                        echo "=== é•œåƒä¿¡æ¯ ==="
                        docker images ${dockerImage} --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}"

                        echo ""
                        echo "âœ“ é•œåƒæ‹‰å–å®Œæˆ"
                    """
                }
            }
        }

        stage('ç¼–è¯‘ Core Layer') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    def ceresFlag = params.ENABLE_CERES ? '--ceres' : ''

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        // ARM Release: Orin ç¡¬ä»¶ç¼–è¯‘ï¼ˆæ— é™åˆ¶ï¼‰
                        echo "ğŸš€ ARM Release æ¨¡å¼ï¼šOrin ç¡¬ä»¶ç¼–è¯‘ (192.168.1.61)"

                        sh """
                            echo "ğŸ·ï¸  ç”Ÿæˆ Layer ç‰ˆæœ¬ä¿¡æ¯..."
                            bash jenkins/generate_layer_versions.sh
                        """

                        sh """
                            echo "ğŸ“¦ åŒæ­¥ä»£ç åˆ° Orinï¼ˆåŒ…å« Git ä¿¡æ¯ï¼‰..."
                            sshpass -p '123456' rsync -avz --delete \
                                --exclude 'build_*_shared' \
                                --exclude 'iiri-ros/install' \
                                ./ wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/
                        """

                        sh """
                            echo "ğŸ³ åœ¨ Orin ä¸Šæ‹‰å–æœ€æ–° Docker é•œåƒ..."
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "docker pull ${env.DOCKER_IMAGE_ARM}"

                            echo ""
                            echo "=== Orin ä¸Šçš„é•œåƒä¿¡æ¯ ==="
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "docker images ${env.DOCKER_IMAGE_ARM} --format 'table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}'"

                            echo ""
                            echo "âœ“ Orin é•œåƒæ‹‰å–å®Œæˆ"
                        """

                        sh """
                            echo "ğŸ”¨ åœ¨ Orin ä¸Šç¼–è¯‘ core_layer (Release æ¨¡å¼ï¼Œå¹¶è¡Œç¼–è¯‘)..."

                            # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "chmod +x ~/jenkins_builds/build_${BUILD_NUMBER}/build_layered.sh"

                            # æ‰§è¡Œç¼–è¯‘
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "cd ~/jenkins_builds/build_${BUILD_NUMBER} && ./build_layered.sh -c arm ${ceresFlag} core_layer"
                        """

                        sh """
                            set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæ‰‹åŠ¨å¤„ç†é”™è¯¯
                            echo "ğŸ“¥ åŒæ­¥ç¼–è¯‘ç»“æœå› Jenkins..."

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/build_arm_shared/ \
                                ./build_arm_shared/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… build_arm_shared åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/iiri-ros/ \
                                ./iiri-ros/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… iiri-ros åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡º
                        """

                    } else {
                        // æœ¬åœ°ç¼–è¯‘ï¼šx86 æˆ– ARM Debug (QEMU)
                        if (params.ARCHITECTURE == 'arm') {
                            echo "ğŸ’» ARM Debug æ¨¡å¼ï¼šJenkins QEMU ç¼–è¯‘ (Debug æ¨¡å¼ï¼Œæœ‰é™åˆ¶)"
                        } else {
                            echo "ğŸ’» x86 æœ¬åœ°ç¼–è¯‘"
                        }

                        sh """
                            ./build_layered.sh -c ${params.ARCHITECTURE} ${ceresFlag} core_layer
                        """
                    }
                }
            }
        }

        stage('ç¼–è¯‘ Hardware Layer') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    def ceresFlag = params.ENABLE_CERES ? '--ceres' : ''

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        echo "ğŸš€ ARM Release: Orin ç¡¬ä»¶ç¼–è¯‘ hardware_layer"

                        sh """
                            # æ‰§è¡Œç¼–è¯‘
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "cd ~/jenkins_builds/build_${BUILD_NUMBER} && ./build_layered.sh -c arm ${ceresFlag} hardware_layer"
                        """
                        sh """
                            set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæ‰‹åŠ¨å¤„ç†é”™è¯¯
                            echo "ğŸ“¦ å›ä¼ ç¼–è¯‘ç»“æœ..."

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/build_arm_shared/ \
                                ./build_arm_shared/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… build_arm_shared åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/iiri-ros/ \
                                ./iiri-ros/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… iiri-ros åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡º
                        """
                    } else {
                        if (params.ARCHITECTURE == 'arm') {
                            echo "ğŸ’» ARM Debug: Jenkins QEMU ç¼–è¯‘ hardware_layer"
                        } else {
                            echo "ğŸ’» x86: æœ¬åœ°ç¼–è¯‘ hardware_layer"
                        }
                        sh """
                            ./build_layered.sh -c ${params.ARCHITECTURE} ${ceresFlag} hardware_layer
                        """
                    }
                }
            }
        }

        stage('ç¼–è¯‘ Perception Layer') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    def ceresFlag = params.ENABLE_CERES ? '--ceres' : ''

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        echo "ğŸš€ ARM Release: Orin ç¡¬ä»¶ç¼–è¯‘ perception_layer"

                        sh """
                            # æ‰§è¡Œç¼–è¯‘
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "cd ~/jenkins_builds/build_${BUILD_NUMBER} && ./build_layered.sh -c arm ${ceresFlag} perception_layer"
                        """
                        sh """
                            set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæ‰‹åŠ¨å¤„ç†é”™è¯¯
                            echo "ğŸ“¦ å›ä¼ ç¼–è¯‘ç»“æœ..."

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/build_arm_shared/ \
                                ./build_arm_shared/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… build_arm_shared åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/iiri-ros/ \
                                ./iiri-ros/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… iiri-ros åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡º
                        """
                    } else {
                        if (params.ARCHITECTURE == 'arm') {
                            echo "ğŸ’» ARM Debug: Jenkins QEMU ç¼–è¯‘ perception_layer"
                        } else {
                            echo "ğŸ’» x86: æœ¬åœ°ç¼–è¯‘ perception_layer"
                        }
                        sh """
                            ./build_layered.sh -c ${params.ARCHITECTURE} ${ceresFlag} perception_layer
                        """
                    }
                }
            }
        }

        stage('ç¼–è¯‘ Intelligence Layer') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    def ceresFlag = params.ENABLE_CERES ? '--ceres' : ''

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        echo "ğŸš€ ARM Release: Orin ç¡¬ä»¶ç¼–è¯‘ intelligence_layer"

                        sh """
                            # æ‰§è¡Œç¼–è¯‘
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "cd ~/jenkins_builds/build_${BUILD_NUMBER} && ./build_layered.sh -c arm ${ceresFlag} intelligence_layer"
                        """
                        sh """
                            set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæ‰‹åŠ¨å¤„ç†é”™è¯¯
                            echo "ğŸ“¦ å›ä¼ ç¼–è¯‘ç»“æœ..."

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/build_arm_shared/ \
                                ./build_arm_shared/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… build_arm_shared åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/iiri-ros/ \
                                ./iiri-ros/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… iiri-ros åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡º
                        """
                    } else {
                        if (params.ARCHITECTURE == 'arm') {
                            echo "ğŸ’» ARM Debug: Jenkins QEMU ç¼–è¯‘ intelligence_layer"
                        } else {
                            echo "ğŸ’» x86: æœ¬åœ°ç¼–è¯‘ intelligence_layer"
                        }
                        sh """
                            ./build_layered.sh -c ${params.ARCHITECTURE} ${ceresFlag} intelligence_layer
                        """
                    }
                }
            }
        }

        stage('æ„å»ºå‰ç«¯ (Frontend)') {
            options {
                timeout(time: 15, unit: 'MINUTES')
            }
            steps {
                script {
                    echo "=== æ„å»º Vue3 å‰ç«¯ ==="

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        echo "ğŸŒ ARM Release: åœ¨ Jenkins æœ¬åœ°æ„å»ºå‰ç«¯ï¼Œç„¶ååŒæ­¥åˆ° Orin"

                        sh """
                            # è¿›å…¥å‰ç«¯ç›®å½•å¹¶æ„å»º
                            cd src/application_layer/src/dev_server/frontend_src

                            echo "æ£€æŸ¥ Node.js ç¯å¢ƒ..."
                            node --version || echo "Node.js æœªå®‰è£…ï¼Œè¯·åœ¨ Jenkins å®¹å™¨ä¸­å®‰è£… Node.js"
                            npm --version || echo "npm æœªå®‰è£…"

                            echo ""
                            echo "å¼€å§‹æ„å»ºå‰ç«¯..."
                            chmod +x build_frontend.sh
                            ./build_frontend.sh

                            echo ""
                            echo "å‰ç«¯æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º..."
                            ls -lh ../static/
                        """

                        sh """
                            echo "åŒæ­¥å‰ç«¯é™æ€æ–‡ä»¶åˆ° Orin..."
                            sshpass -p '123456' rsync -avz \
                                src/application_layer/src/dev_server/static/ \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/src/application_layer/src/dev_server/static/

                            echo ""
                            echo "âœ“ å‰ç«¯æ–‡ä»¶å·²åŒæ­¥åˆ° Orin"
                        """
                    } else {
                        echo "ğŸŒ æœ¬åœ°æ„å»ºå‰ç«¯"

                        sh """
                            # è¿›å…¥å‰ç«¯ç›®å½•å¹¶æ„å»º
                            cd src/application_layer/src/dev_server/frontend_src

                            echo "æ£€æŸ¥ Node.js ç¯å¢ƒ..."
                            node --version || echo "Node.js æœªå®‰è£…ï¼Œè¯·åœ¨ Jenkins å®¹å™¨ä¸­å®‰è£… Node.js"
                            npm --version || echo "npm æœªå®‰è£…"

                            echo ""
                            echo "å¼€å§‹æ„å»ºå‰ç«¯..."
                            chmod +x build_frontend.sh
                            ./build_frontend.sh

                            echo ""
                            echo "å‰ç«¯æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º..."
                            ls -lh ../static/
                        """
                    }
                }
            }
        }

        stage('ç¼–è¯‘ Application Layer') {
            options {
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    def ceresFlag = params.ENABLE_CERES ? '--ceres' : ''

                    if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                        echo "ğŸš€ ARM Release: Orin ç¡¬ä»¶ç¼–è¯‘ application_layer (å‰ç«¯å·²å°±ç»ª)"

                        sh """
                            # æ‰§è¡Œç¼–è¯‘
                            sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                                "cd ~/jenkins_builds/build_${BUILD_NUMBER} && ./build_layered.sh -c arm ${ceresFlag} application_layer"
                        """
                        sh """
                            set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæ‰‹åŠ¨å¤„ç†é”™è¯¯
                            echo "ğŸ“¦ å›ä¼ ç¼–è¯‘ç»“æœ..."

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/build_arm_shared/ \
                                ./build_arm_shared/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… build_arm_shared åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            sshpass -p '123456' rsync -avzL \
                                wl@192.168.1.61:~/jenkins_builds/build_${BUILD_NUMBER}/iiri-ros/ \
                                ./iiri-ros/
                            rsync_exit_code=\$?
                            if [ \$rsync_exit_code -ne 0 ] && [ \$rsync_exit_code -ne 23 ]; then
                                echo "âŒ rsync failed with exit code \$rsync_exit_code"
                                exit 1
                            fi
                            echo "âœ… iiri-ros åŒæ­¥å®Œæˆ (exit code: \$rsync_exit_code)"

                            set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡º
                        """
                    } else {
                        if (params.ARCHITECTURE == 'arm') {
                            echo "ğŸ’» ARM Debug: Jenkins QEMU ç¼–è¯‘ application_layer"
                        } else {
                            echo "ğŸ’» x86: æœ¬åœ°ç¼–è¯‘ application_layer"
                        }
                        sh """
                            ./build_layered.sh -c ${params.ARCHITECTURE} ${ceresFlag} application_layer
                        """
                    }
                }
            }
        }

        stage('æ‰“åŒ…éƒ¨ç½²åŒ…') {
            steps {
                echo "=== æ‰“åŒ… iiri-ros éƒ¨ç½²åŒ… (${params.ARCHITECTURE}) ==="
                sh """
                    # ç¡®ä¿æ‰“åŒ…è„šæœ¬å¯æ‰§è¡Œ
                    chmod +x deploy_package.sh

                    # æ‰§è¡Œæ‰“åŒ…ï¼ˆç”Ÿæˆæç®€éƒ¨ç½²åŒ…ï¼‰
                    ./deploy_package.sh ${params.ARCHITECTURE} deploy_packages

                    # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
                    echo ""
                    echo "=== æ‰“åŒ…å®Œæˆ ==="
                    ls -lh deploy_packages/*.tar.gz
                    ls -lh deploy_packages/*.sha256 2>/dev/null || echo "(æœªç”Ÿæˆæ ¡éªŒæ–‡ä»¶)"

                    # æ˜¾ç¤ºéƒ¨ç½²åŒ…å†…å®¹
                    echo ""
                    echo "=== éƒ¨ç½²åŒ…å†…å®¹é¢„è§ˆ ==="
                    tar -tzf deploy_packages/*.tar.gz | head -20
                """
            }
        }
    }

    post {
        always {
            script {
                if (params.ARCHITECTURE == 'arm' && params.BUILD_MODE == 'release') {
                    echo "ğŸ§¹ æ¸…ç† Orin æ„å»ºç›®å½•..."
                    sh """
                        sshpass -p '123456' ssh -o StrictHostKeyChecking=no wl@192.168.1.61 \
                            "echo '123456' | sudo -S rm -rf ~/jenkins_builds/build_${BUILD_NUMBER}" || true
                    """
                }
            }
        }

        success {
            echo '=== æ‰€æœ‰å±‚ç¼–è¯‘æˆåŠŸ! ==='

            // å½’æ¡£éƒ¨ç½²åŒ…åˆ°Jenkinsä¾›ä¸‹è½½ï¼ˆä¸»è¦äº§ç‰©ï¼‰
            echo '=== å½’æ¡£éƒ¨ç½²åŒ… ==='
            archiveArtifacts artifacts: "deploy_packages/*.tar.gz",
                             fingerprint: true,
                             allowEmptyArchive: false

            // å½’æ¡£ SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            archiveArtifacts artifacts: "deploy_packages/*.sha256",
                             fingerprint: false,
                             allowEmptyArchive: true

            // å½’æ¡£ç‰ˆæœ¬ä¿¡æ¯
            archiveArtifacts artifacts: "deploy_packages/*/VERSION.txt",
                             fingerprint: false,
                             allowEmptyArchive: true

            // å½’æ¡£ç¼–è¯‘æ—¥å¿—ï¼ˆæ¬¡è¦äº§ç‰©ï¼‰
            echo '=== å½’æ¡£ç¼–è¯‘æ—¥å¿— ==='
            archiveArtifacts artifacts: "build_${params.ARCHITECTURE}_shared/*/log/**/*.log",
                             fingerprint: false,
                             allowEmptyArchive: true

            echo ''
            echo '=========================================='
            echo 'ğŸ‰ éƒ¨ç½²åŒ…å·²å½’æ¡£ï¼'
            echo '=========================================='
            echo ''
            echo 'ğŸ“¦ ä» Jenkins UI ä¸‹è½½éƒ¨ç½²åŒ…åï¼Œä½¿ç”¨æç®€éƒ¨ç½²ï¼š'
            echo ''
            echo '1ï¸âƒ£  è§£å‹å¹¶è¿›å…¥ç›®å½•ï¼š'
            echo '   tar -xzf iiri-ros-*.tar.gz -C /home/wl/autorun/ && cd /home/wl/autorun/iiri-ros-*'
            echo ''
            echo '2ï¸âƒ£  ä¸€é”®å®‰è£…ï¼ˆè‡ªåŠ¨åˆ›å»ºç¬¦å·é“¾æ¥å¹¶å¯åŠ¨æœåŠ¡ï¼‰ï¼š'
            echo '   sudo ./install.sh'
            echo ''
            echo 'ğŸ”„ ç‰ˆæœ¬ç®¡ç†å‘½ä»¤ï¼š'
            echo '   åˆ—å‡ºç‰ˆæœ¬: sudo /home/wl/autorun/switch-version.sh list'
            echo '   åˆ‡æ¢ç‰ˆæœ¬: sudo /home/wl/autorun/switch-version.sh <ç‰ˆæœ¬å·>'
            echo '   å›æ»šç‰ˆæœ¬: sudo /home/wl/autorun/switch-version.sh rollback'
            echo ''
            echo 'ğŸ“š è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹éƒ¨ç½²åŒ…ä¸­çš„ DEPLOY.md'
            echo '=========================================='
        }

        failure {
            echo '=== ç¼–è¯‘å¤±è´¥! ==='

            // å¤±è´¥æ—¶å½’æ¡£æ—¥å¿—ç”¨äºè°ƒè¯•
            echo '=== å½’æ¡£å¤±è´¥æ—¥å¿— ==='
            archiveArtifacts artifacts: "build_${params.ARCHITECTURE}_shared/*/log/**/*.log",
                             fingerprint: false,
                             allowEmptyArchive: true
        }
    }
}
